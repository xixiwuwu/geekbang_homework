<pre>
    <script>

        class XRegExp {
            constructor(source, flag, root = "root") {
                //定义词法表格
                this.table = new Map();
                //遍历循环解析
                this.regexp = new RegExp(this.compileRegExp(source, root, 0).source, flag);
                //打印正则
                console.log(this.regexp);
                //打印词法表格
                console.log(this.table);
            }

            compileRegExp(source, name, start) {
                //如果值为正则 返回名字和长度
                if (source[name] instanceof RegExp)
                    return {
                        source: source[name].source,
                        length: 0
                    };

                let length = 0;

                //使用replace将占位字符替换为正则表达式
                let regexp = source[name].replace(/\<([^>]+)\>/g, (str, $1) => {
                    this.table.set(start + length, $1);
                    for(let a of this.table)
                        console.log("table:" + a[0] + "=" + a[1]);

                    ++length;
                    //递归调用继续解析
                    let r = this.compileRegExp(source, $1, start + length);
                    
                    length += r.length;
                    return "(" + r.source + ")";
                });
                console.log("regexp="+regexp);
                return{
                    source: regexp,
                    length: length
                };
            }

            exec(string) {
                let r = this.regexp.exec(string);
                //循环匹配词法表 返回匹配结果
                for (let i = 1; i < r.length; i++) {
                    if (r[i] !== void 0) {
                        r[this.table.get(i - 1)] = r[i];                        
                    }
                }
                return r;
            }

            //上一次匹配文本之后的第一个字符的位置
            get lastIndex() {
                return this.regexp.lastIndex;
            }

            set lastIndex(value) {
                return this.regexp.lastIndex = value;
            }
        }

        function scan(str) {
            //定义扩展巴科斯范式ABNF 词法分析js规则和正则Map
            let regexp = new XRegExp({
                InputElement: "<Whitespace>|<LineTerminator>|<Comments>|<Token>",
                Whitespace: / /,
                LineTerminator: /\n/,
                Comments: /\/\*(?:[^*]|\*[^\/])*\*\/|\/\/[^\n]*/,
                Token: "<Literal>|<Keywords>|<Identifer>|<Punctuator>",
                Literal: "<NumericLiteral>|<BooleanLiteral>|<StringLiteral>|<NullLiteral>",
                NumericLiteral: /(?:[1-9][0-9]*|0)(?:\.[0-9]*)?|\.[0-9]+/,
                BooleanLiteral: /true|false/,
                StringLiteral: /\"(?:[^"\n]|\\[\s\S])*\"|\'(?:[^'\n]|\\[\s\S])*\'/,
                NullLiteral: /null/,
                Keywords: /if|else|for|function|let|var/,
                Identifer: /[a-zA-Z_$][a-zA-Z0-9_$]*/,
                Punctuator: /\+|\,|\?|\:|\{|\}|\.|\(|\=|\<|\+\+|\=\=|\=\>|\*|\)|\[|\]|;/
                }, "g", "InputElement"); //匹配全部 定义处理第一个元素name

            while (regexp.lastIndex < str.length) {
                let r = regexp.exec(str);
                console.log(r);
                //console.log(JSON.stringify(r[0]));
                //debugger;
                //document.write(r);
                if(!r[0].length)
                    break;
            }
        }

        //词法分析内容        
        scan(
            `
            for(let i = 0; i < 3; i++){
                for(let j = 0; j < 3; j++){
                    let cell = document.createElement("div");
                    cell.classList.add("cell");
                    cell.innerText = pattern[i * 3 + j] == 2 ? "X" :
                        pattern[i + 3 + j] == 1 ? "O" : "";
                    cell.addEventListener("click", () => userMove(j, i));
                    board.appendChild(cell);
                }
                board.appendChild(document.createElement("br"));
            }
            `
        )
    </script>
</pre>